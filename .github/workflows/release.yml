name: Release

permissions:
  contents: write
  pull-requests: write
  id-token: write
  attestations: write

concurrency:
  group: release-${{ github.run_id }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'build.rs'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build and Test
    runs-on: windows-latest
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      last_version: ${{ steps.last_version.outputs.LAST_VERSION }}
      binary_path: ${{ steps.build_info.outputs.BINARY_PATH }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo registry
      uses: actions/cache@v5
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v5
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v5
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build
      run: cargo build --verbose
    
    - name: Run tests
      run: cargo test --verbose
    
    - name: Get version from Cargo.toml
      id: version
      shell: pwsh
      run: |
        $content = Get-Content Cargo.toml -Raw
        $content -match 'version = "([^"]+)"' | Out-Null
        $version = $matches[1]
        Write-Output "VERSION=$version" >> $env:GITHUB_OUTPUT
        Write-Output "Version: $version"
    
    - name: Get last release version
      id: last_version
      shell: pwsh
      run: |
        try {
          $response = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest" `
            -Headers @{ Authorization = "Bearer ${{ secrets.GITHUB_TOKEN }}" } `
            -ErrorAction Stop
          $lastTag = $response.tag_name -replace '^v', ''
          Write-Output "LAST_VERSION=$lastTag" >> $env:GITHUB_OUTPUT
          Write-Output "Last version: $lastTag"
        } catch {
          Write-Output "LAST_VERSION=0.0.0" >> $env:GITHUB_OUTPUT
          Write-Output "No previous releases found"
        }
    
    - name: Build release binary
      run: cargo build --release
    
    - name: Capture build information
      id: build_info
      shell: pwsh
      run: |
        $binaryPath = Resolve-Path 'target/release/wincamcfg.exe'
        Write-Output "BINARY_PATH=$binaryPath" >> $env:GITHUB_OUTPUT
        Write-Output "Binary path: $binaryPath"
    
    - name: Upload binary artifact
      uses: actions/upload-artifact@v6
      with:
        name: release-binary
        path: target/release/wincamcfg.exe

  version-check:
    name: Verify Version Updated
    needs: build
    runs-on: windows-latest
    
    steps:
    - name: Check version bump
      shell: pwsh
      run: |
        $currentVersion = "${{ needs.build.outputs.version }}"
        $lastVersion = "${{ needs.build.outputs.last_version }}"
        
        if ($currentVersion -eq $lastVersion) {
          Write-Error "Version in Cargo.toml ($currentVersion) has not been updated from the last release ($lastVersion). Please bump the version."
          exit 1
        }
        Write-Output "Version updated from $lastVersion to $currentVersion âœ“"

  tag-check:
    name: Check Git Tag
    needs: build
    runs-on: windows-latest
    outputs:
      tag_exists: ${{ steps.check_tag.outputs.TAG_EXISTS }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Check if tag already exists
      id: check_tag
      shell: pwsh
      run: |
        $tag = "v${{ needs.build.outputs.version }}"
        $tagExists = @(git tag -l $tag).Count -gt 0
        if ($tagExists) {
          Write-Output "TAG_EXISTS=true" >> $env:GITHUB_OUTPUT
          Write-Output "Tag $tag already exists"
        } else {
          Write-Output "TAG_EXISTS=false" >> $env:GITHUB_OUTPUT
          Write-Output "Tag $tag does not exist, will create"
        }

  changelog:
    name: Update Changelog
    needs: [build, version-check, tag-check]
    if: needs.tag-check.outputs.tag_exists == 'false'
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Update CHANGELOG.md
      shell: pwsh
      run: |
        $version = "${{ needs.build.outputs.version }}"
        $lastVersion = "${{ needs.build.outputs.last_version }}"
        $changelogPath = "CHANGELOG.md"
        $changelog = Get-Content $changelogPath -Raw
        
        $versionPattern = [regex]::Escape($version)
        if ($changelog -match "\[$versionPattern\]") {
          Write-Output "Version $version already in CHANGELOG.md"
          exit 0
        }
        
        if ($lastVersion -eq "0.0.0") {
          $gitLog = git log --oneline --pretty="- %s" -- src/ Cargo.toml build.rs
        } else {
          $gitLog = git log "v$lastVersion..HEAD" --oneline --pretty="- %s" -- src/ Cargo.toml build.rs
        }
        
        $today = Get-Date -Format "yyyy-MM-dd"
        $newEntry = "## [$version] - $today`n`n### Changed`n$gitLog`n"
        
        $lines = $changelog -split "`n"
        $insertIndex = 0
        for ($i = 0; $i -lt $lines.Count; $i++) {
          if ($lines[$i] -match "^## \[") {
            $insertIndex = $i
            break
          }
        }
        
        $updatedChangelog = (($lines[0..($insertIndex - 1)] | Join-String -Separator "`n")) + "`n$newEntry" + (($lines[$insertIndex..($lines.Count - 1)] | Join-String -Separator "`n"))
        Set-Content $changelogPath $updatedChangelog -Encoding UTF8
        
        Write-Output "Updated CHANGELOG.md with version $version"
    
    - name: Commit and push changelog
      shell: pwsh
      run: |
        if (git diff --quiet) {
          Write-Output "No changelog changes to commit"
        } else {
          git add CHANGELOG.md
          git commit -m "docs: update changelog for v${{ needs.build.outputs.version }}"
          git push origin HEAD:main
        }

  create-tag:
    name: Create Git Tag
    needs: [build, changelog]
    if: needs.tag-check.outputs.tag_exists == 'false'
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Create and push git tag
      run: |
        git tag -a v${{ needs.build.outputs.version }} -m "Release v${{ needs.build.outputs.version }}"
        git push origin v${{ needs.build.outputs.version }}

  sbom-generation:
    name: Generate SBOMs
    needs: build
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo registry
      uses: actions/cache@v5
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v5
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Install cargo-sbom
      run: cargo install cargo-sbom --locked
    
    - name: Generate SBOM (SPDX)
      run: cargo sbom --output-format spdx_json_2_3 > sbom.spdx.json
    
    - name: Generate SBOM (CycloneDX)
      run: cargo sbom --output-format cyclone_dx_json_1_6 > sbom.cyclonedx.json
    
    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v6
      with:
        name: sbom-artifacts
        path: sbom*.json

  attestations:
    name: Generate Attestations
    needs: [build, sbom-generation]
    runs-on: windows-latest
    permissions:
      id-token: write
      attestations: write
    
    steps:
    - name: Download binary artifact
      uses: actions/download-artifact@v5
      with:
        name: release-binary
    
    - name: Download SBOM artifacts
      uses: actions/download-artifact@v5
      with:
        name: sbom-artifacts
    
    - name: Generate artifact attestation
      uses: actions/attest-build-provenance@v3
      with:
        subject-path: 'wincamcfg.exe'
    
    - name: Generate SBOM attestation
      uses: actions/attest-sbom@v3
      with:
        subject-path: 'wincamcfg.exe'
        sbom-path: 'sbom.spdx.json'

  create-release:
    name: Create GitHub Release
    needs: [build, create-tag, sbom-generation, attestations]
    if: needs.tag-check.outputs.tag_exists == 'false'
    runs-on: windows-latest
    
    steps:
    - name: Download binary artifact
      uses: actions/download-artifact@v5
      with:
        name: release-binary
    
    - name: Download SBOM artifacts
      uses: actions/download-artifact@v5
      with:
        name: sbom-artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.build.outputs.version }}
        draft: false
        prerelease: false
        files: |
          wincamcfg.exe
          sbom.spdx.json
          sbom.cyclonedx.json
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
